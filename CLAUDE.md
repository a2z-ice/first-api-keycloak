# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

OAuth2.1-secured Student Management System using Keycloak (26.5.3) as the identity provider. The system is split into a **React 19 SPA frontend** (served by Nginx) and a **FastAPI JSON API backend**, deployed separately in a Kind (Kubernetes-in-Docker) cluster. Nginx proxies `/api` requests to FastAPI (BFF pattern), so OAuth tokens never reach the browser. Keycloak runs as a 3-replica StatefulSet with HTTPS and jdbc-ping clustering. The FastAPI backend (3 replicas) uses Authlib for OAuth2.1 + PKCE (S256) with Redis-backed sessions and PostgreSQL for persistent storage.

## Setup and Run Commands

```bash
# Full setup (certs, Kind cluster, Keycloak deploy, realm config, Python venv, npm install, seed data)
./setup.sh

# Tear down everything (cluster, certs, DB, venv, node_modules)
./cleanup.sh

# Start backend locally (from backend/ with venv activated)
cd backend && source venv/bin/activate && python run.py

# Start frontend dev server (proxies /api to backend)
cd frontend && npm run dev

# Run Playwright E2E tests against deployed app
cd frontend && APP_URL=http://localhost:30000 npx playwright test

# Run tests with HTML report
cd frontend && npx playwright test --reporter=html

# Build, deploy to Kind, and test (all-in-one)
./scripts/build-test-deploy.sh

# Build and deploy only (skip tests)
./scripts/build-test-deploy.sh --deploy-only

# Test already-deployed app only
./scripts/build-test-deploy.sh --test-only

# Deploy pipeline (alternative script)
./scripts/deploy-and-test.sh

# Run tests with helper script
./scripts/run-tests.sh --deployed
./scripts/run-tests.sh --local --start-app

# Verify Keycloak deployment
./scripts/verify-deployment.sh

# Run fail-screenshot demo (verifies Playwright captures screenshots on failure)
./scripts/test-fail-screenshot.sh
```

**Prerequisites:** `127.0.0.1 idp.keycloak.com` must be in `/etc/hosts`. Requires kind, kubectl, docker, python3, node/npm, and Playwright browsers (`npx playwright install`).

## ArgoCD GitOps Pipeline Commands

```bash
# Setup full GitOps infrastructure (registry + ArgoCD + Jenkins + Keycloak clients)
./scripts/setup-infrastructure.sh

# Setup individual components
./scripts/setup-registry.sh          # Start local Docker registry on localhost:5001
./scripts/setup-argocd.sh            # Install ArgoCD v3.0.5 + Nginx Ingress + CoreDNS patch
./scripts/setup-jenkins.sh           # Generate kubeconfig + start Jenkins via docker compose
./scripts/setup-keycloak-envs.sh     # Create dev + prod Keycloak clients

# Verify infrastructure
curl http://localhost:5001/v2/_catalog    # Registry: {"repositories":[...]}
argocd app list                          # Shows student-app-dev and student-app-prod
kubectl get ns | grep student-app        # List environment namespaces

# Full automated pipeline test (all three phases: dev → PR preview → prod)
GITHUB_TOKEN=<pat> ./scripts/cicd-pipeline-test.sh --skip-setup

# Retrieve GITHUB_TOKEN from the k8s secret if not in environment
GITHUB_TOKEN=$(kubectl get secret github-token -n argocd -o jsonpath='{.data.token}' | base64 -d)

# Pipeline test flags
./scripts/cicd-pipeline-test.sh --skip-setup              # Skip Phase 0 (infra already running)
./scripts/cicd-pipeline-test.sh --skip-setup --skip-phase1  # Only run Phase 2 + 3
./scripts/cicd-pipeline-test.sh --skip-setup --pr-number 5  # Reuse existing PR #5
```

**`/etc/hosts` for GitOps environments** — entries must be added manually (the script does not use sudo):
```bash
# One-time: dev + prod
echo '127.0.0.1 dev.student.local prod.student.local' | sudo tee -a /etc/hosts

# Per PR preview run (script warns what to add; add before running):
echo '127.0.0.1 pr-5.student.local' | sudo tee -a /etc/hosts
# After PR is closed and cleaned up:
sudo sed -i '' '/pr-5.student.local/d' /etc/hosts
```

## Architecture

### BFF (Backend-for-Frontend) Pattern

```
Browser (localhost:30000)
    |
    v
Nginx (React SPA + API Proxy)   <-- NodePort 30000
    |         |
    |         v
    |    FastAPI API             <-- ClusterIP 8000
    |         |       |
    |         v       v
    |      Redis    App PostgreSQL
    |
    v
Keycloak (NodePort 31111)
```

**Auth flow:**
1. React -> `/api/auth/login` -> Nginx proxies to FastAPI -> redirects to Keycloak
2. Keycloak authenticates -> redirects to `/api/auth/callback` -> Nginx proxies to FastAPI
3. FastAPI stores tokens in Redis session, sets cookie, redirects to `http://localhost:30000/`
4. React calls `GET /api/auth/me` -> gets user + roles from session
5. Logout: React calls `POST /api/auth/logout` -> gets Keycloak logout URL -> navigates there

### Infrastructure (`keycloak/`, `cluster/`, `certs/`, `scripts/`)

- **Kind cluster** configured in `cluster/kind-config.yaml` with NodePort 31111 (Keycloak), 32000 (legacy), 30000 (frontend)
- **Self-signed TLS** generated by `certs/generate-certs.sh` (CA + server cert for `idp.keycloak.com`)
- **Keycloak PostgreSQL** single pod (manifests in `keycloak/postgresql/`)
- **App PostgreSQL** single pod for backend data (manifests in `keycloak/app-postgresql/`), credentials: `appuser`/`apppass`/`studentdb`
- **Redis** single pod for session storage (manifests in `keycloak/redis/`)
- **Keycloak StatefulSet** (3 replicas) with HTTPS on 8443, health on 9000, jdbc-ping cache stack
- **FastAPI Deployment** (3 replicas) in `keycloak/fastapi-app/` — uses `__NODE_IP__` placeholder for `hostAliases`
- **Frontend Deployment** (3 replicas) in `keycloak/frontend/` — Nginx serving React SPA, proxying `/api` to FastAPI
- **Realm setup** (`keycloak/realm-config/realm-setup.sh`) creates `student-mgmt` realm, `student-app` client, three roles

### Backend (`backend/`)

- **Entry point:** `run.py` -> `app/main.py` (uvicorn with reload)
- **Config:** `config.py` uses pydantic-settings. Key settings: `database_url`, `redis_url`, `keycloak_url`, `frontend_url`
- **OAuth:** `app/auth.py` registers Keycloak as Authlib OAuth provider with custom SSL context
- **Auth flow:** `app/routes/auth_routes.py` handles `/api/auth/login`, `/api/auth/callback`, `/api/auth/me`, `/api/auth/logout`
- **Session middleware:** `app/session.py` — custom `RedisSessionMiddleware` (ASGI) with 14-day TTL
- **RBAC:** `app/dependencies.py` — `require_authenticated`, `require_admin`, `get_student_for_user`
- **Schemas:** `app/schemas.py` — Pydantic models for Student/Department/User request/response
- **Database:** `app/database.py` — SQLAlchemy with conditional `connect_args` (SQLite or PostgreSQL)
- **Routes:** `app/routes/` — JSON API endpoints under `/api/students/` and `/api/departments/`
- **Health:** `GET /api/health` -> `{"status": "ok"}`

### Frontend (`frontend/`)

- **Stack:** Vite + React 19 + TypeScript + React Router 7
- **Styles:** Plain CSS with CSS custom properties for dark mode (`App.css`)
- **API layer:** `src/api/` — fetch wrapper with `credentials: 'include'`
- **Auth:** `src/contexts/AuthContext.tsx` — calls `/api/auth/me` on mount
- **Theme:** `src/contexts/ThemeContext.tsx` — dark mode with localStorage persistence
- **Components:** Navbar (with theme toggle), ProtectedRoute, AdminRoute
- **Pages:** Login, Dashboard, Student (list/detail/form), Department (list/detail/form)
- **Nginx:** `nginx.conf` — proxies `/api/` to `fastapi-app:8000`, SPA fallback for other routes
- **Docker:** Multi-stage build (node:22 -> nginx:1.27-alpine)

### Tests (`frontend/tests/e2e/`)

46+ E2E tests using **Playwright**. `playwright.config.ts` uses `APP_URL` env var (default: `http://localhost:30000`). HTML reporter generates `frontend/playwright-report/index.html`.

Test files: `auth.spec.ts`, `students.spec.ts`, `departments.spec.ts`, `navigation.spec.ts`, `validation.spec.ts`, `errors.spec.ts`, `dark-mode.spec.ts`.

### Fail-Screenshot Demo (`frontend/tests/e2e-fail-demo/`)

Isolated test that deliberately fails to verify Playwright captures screenshots on failure. Uses a separate config (`playwright-fail-demo.config.ts`) with `screenshot: 'only-on-failure'`. Run with `./scripts/test-fail-screenshot.sh`. Report at `frontend/playwright-fail-demo-report/index.html`. Auto-generated artifacts (`playwright-fail-demo-report/`, `test-results/`) are git-ignored. See `plans/4-playwright-fail-screenshot-demo.md` for details.

## Key URLs and Credentials

| Service | URL |
|---------|-----|
| Frontend (deployed) | http://localhost:30000 |
| Frontend (dev) | http://localhost:5173 |
| Backend (local) | http://localhost:8000 |
| Keycloak | https://idp.keycloak.com:31111 |
| Keycloak Admin | admin / admin |

Test users: `admin-user`/`admin123` (admin), `student-user`/`student123` (student), `staff-user`/`staff123` (staff)

## Role Permissions Matrix

| Action | admin | staff | student |
|--------|-------|-------|---------|
| View all students | yes | yes | no (own only) |
| Create/edit students | yes | no | no |
| View all departments | yes | yes | yes |
| Create/edit departments | yes | no | no |

## API Endpoints

| Method | Path | Auth | Description |
|--------|------|------|-------------|
| GET | `/api/auth/login` | none | Redirect to Keycloak |
| GET | `/api/auth/callback` | none | OAuth callback |
| GET | `/api/auth/me` | session | Current user + roles |
| POST | `/api/auth/logout` | session | Returns logout URL |
| GET | `/api/students/` | authenticated | List students (role-filtered) |
| POST | `/api/students/` | admin | Create student |
| GET | `/api/students/{id}` | authenticated | Student detail |
| PUT | `/api/students/{id}` | admin | Update student |
| GET | `/api/departments/` | authenticated | List departments |
| POST | `/api/departments/` | admin | Create department |
| GET | `/api/departments/{id}` | authenticated | Department detail |
| PUT | `/api/departments/{id}` | admin | Update department |
| GET | `/api/health` | none | Health check |

## Deployment Pipeline

### Scripts

- **`scripts/build-test-deploy.sh`** — All-in-one: build Docker images (backend + frontend), deploy to Kind, seed DB, run Playwright tests. Flags: `--skip-local`, `--deploy-only`, `--test-only`
- **`scripts/deploy-and-test.sh`** — Alternative deploy pipeline with flags: `--skip-build`, `--only-deploy`, `--only-test-deployed`
- **`scripts/run-tests.sh`** — Reusable Playwright test runner. Flags: `--deployed`, `--local`, `--start-app`, `--filter`
- **`scripts/create-test-data.py`** — Seeds departments + students (idempotent)
- **`scripts/test-fail-screenshot.sh`** — Runs a deliberately-failing test to verify Playwright screenshot capture on failure

### Key Deployment Details

- Backend image: `fastapi-student-app:latest`
- Frontend image: `frontend-student-app:latest`
- Frontend NodePort: 30000; Backend ClusterIP: 8000
- `app-deployment.yaml` uses `__NODE_IP__` placeholder for `hostAliases`
- Deploy scripts update Keycloak client redirect URIs to include port 30000
- Playwright HTML reports generated at `frontend/playwright-report/index.html`

## ArgoCD GitOps Architecture

### Environment URLs

| Service | URL | Notes |
|---------|-----|-------|
| Jenkins UI | http://localhost:8090 | `docker exec jenkins cat /var/jenkins_home/secrets/initialAdminPassword` |
| Local Registry | http://localhost:5001/v2/_catalog | registry:2 container |
| ArgoCD UI | http://localhost:30080 | `kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' \| base64 -d` |
| Dev App | http://dev.student.local:8080 | Add `127.0.0.1 dev.student.local` to /etc/hosts |
| Prod App | http://prod.student.local:8080 | Add `127.0.0.1 prod.student.local` to /etc/hosts |
| PR Preview | http://pr-{N}.student.local:8080 | Added/removed dynamically by Jenkins |

### Key GitOps Files

- `gitops/argocd/applicationsets/environments.yaml` — List Generator: manages dev + prod Applications
- `gitops/argocd/applicationsets/pr-preview.yaml` — PullRequest Generator: creates ephemeral PR preview Applications
- `gitops/argocd/secrets/github-token-secret.yaml` — Template for GitHub token secret (apply manually)
- `gitops/environments/base/` — Kustomize base (no namespace, no env-specific values)
- `gitops/environments/overlays/dev/` — Dev overlay (image tags updated by Jenkins CI)
- `gitops/environments/overlays/prod/` — Prod overlay (promoted from dev after E2E pass)
- `gitops/environments/overlays/preview/` — Shared PR preview template (values injected by ApplicationSet)
- `jenkins/Dockerfile` + `jenkins/docker-compose.yml` — Jenkins with docker, kubectl, argocd CLI, gh CLI
- `jenkins/pipelines/Jenkinsfile.pr-preview` — PR preview pipeline (build → push → label → wait → E2E → merge)
- `jenkins/pipelines/Jenkinsfile.dev` — Dev pipeline (build → push → update overlay → wait → E2E → open PR)
- `jenkins/pipelines/Jenkinsfile.prod` — Prod pipeline (reuse dev tag → update overlay → wait → E2E)

### CoreDNS Override

`setup-argocd.sh` patches CoreDNS so all pods resolve `idp.keycloak.com` to the Kind node IP — this removes the need for `hostAliases` in any deployment manifest.

### Jenkins Credentials Required

- `GITHUB_TOKEN` — GitHub PAT for `gh pr merge`, `gh pr create`, label management
- `ARGOCD_PASSWORD` — ArgoCD admin password for `argocd` CLI commands
- Git SSH key or HTTPS token — for pushing overlay commits to GitHub

### Critical Gotchas (ArgoCD CI/CD)

- **`containerdConfigPatches` crashes kubelet** on macOS + Docker Desktop + kindest/node:v1.35. Registry mirror must be configured post-creation via `setup-registry.sh` (writes `/etc/containerd/certs.d/localhost:5001/hosts.toml` into node).
- **PR image SHA is 8 chars**: ArgoCD `{{head_short_sha}}` = 8 chars. Always use `git rev-parse HEAD | cut -c1-8` or GitHub API `sha[:8]` when tagging PR images. 7-char tags will cause `ImagePullBackOff`.
- **`keycloak-tls` secret must be copied** to each env namespace (`student-app-dev`, `student-app-prod`, `student-app-pr-{N}`). `setup-argocd.sh` pre-copies for dev/prod; Jenkins Jenkinsfile handles PR preview.
- **Per-env Keycloak client secrets**: Base secret has `KEYCLOAK_CLIENT_SECRET: student-app-secret` but each env uses a different client (e.g., `student-app-dev-secret`). Each overlay must have `patches/secret-patch.yaml` replacing this value.
- **PR label via REST API**: `gh pr edit --add-label` may silently fail if token lacks `read:org`. Use the GitHub REST API directly: `POST /repos/{owner}/{repo}/issues/{n}/labels`.
- **ArgoCD watches branches**: `dev` overlay is watched on `dev` branch; `prod` overlay on `main`. Both branches must have the `gitops/` directory. Create them from `cicd`: `git push origin cicd:dev && git push origin cicd:main`.
- **DB seeding via inline Python**: The `create-test-data.py` script is not baked into the image. Use `kubectl exec` with inline Python (see `cicd-test-instruction.md` for the full seeding block).
- **Seed must RESTORE student names**: E2E test `admin can edit a student` renames "Student User" to "Edited Student Name" permanently. The seed script in `cicd-pipeline-test.sh` checks `if su.name != 'Student User': su.name = 'Student User'` to restore it before each run.
- **No sudo in pipeline script**: `cicd-pipeline-test.sh` never calls sudo (macOS sudo writes to `/dev/tty`, bypassing `2>/dev/null` and causing unexpected exits). The script warns what `/etc/hosts` entries to add and the user must add them manually.
- **GITHUB_TOKEN must be set explicitly**: It is not inherited from the login session. Either `export GITHUB_TOKEN=<pat>` or retrieve from the k8s secret: `kubectl get secret github-token -n argocd -o jsonpath='{.data.token}' | base64 -d`.

### Full Test Guide

See `cicd-test-instruction.md` for the complete step-by-step instructions to test all three pipeline phases (dev, PR preview, prod promotion) with exact shell commands.
