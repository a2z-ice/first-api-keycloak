# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

OAuth2.1-secured Student Management System using Keycloak (26.5.3) as the identity provider and FastAPI as the application framework. Keycloak runs as a 3-replica StatefulSet in a Kind (Kubernetes-in-Docker) cluster with HTTPS and jdbc-ping clustering. The FastAPI app (3 replicas) uses Authorization Code + PKCE (S256) flow via Authlib, with Redis-backed sessions for multi-replica consistency and PostgreSQL for persistent storage.

## Setup and Run Commands

```bash
# Full setup (certs, Kind cluster, Keycloak deploy, realm config, Python venv, seed data)
./setup.sh

# Tear down everything (cluster, certs, DB, venv)
./cleanup.sh

# Start FastAPI app locally (from fastapi-app/ with venv activated)
cd fastapi-app && source venv/bin/activate && python run.py

# Run E2E tests (requires Keycloak cluster + FastAPI running)
cd fastapi-app && source venv/bin/activate && pytest tests/ -v

# Run a single test
cd fastapi-app && pytest tests/test_e2e.py::TestStudentCRUD::test_create_student -v

# Run tests with helper script (starts Redis + app automatically)
./scripts/run-tests.sh --start-app

# Run tests against deployed app
./scripts/run-tests.sh --deployed

# Build, deploy to Kind, and test (all-in-one)
./scripts/build-test-deploy.sh

# Build and deploy only (skip tests)
./scripts/build-test-deploy.sh --deploy-only

# Test already-deployed app only
./scripts/build-test-deploy.sh --test-only

# Deploy pipeline (alternative script)
./scripts/deploy-and-test.sh

# Verify Keycloak deployment
./scripts/verify-deployment.sh
```

**Prerequisites:** `127.0.0.1 idp.keycloak.com` must be in `/etc/hosts`. Requires kind, kubectl, docker, python3, and Playwright browsers (`playwright install`).

## Architecture

### Infrastructure (`keycloak/`, `cluster/`, `certs/`, `scripts/`)

- **Kind cluster** configured in `cluster/kind-config.yaml` with NodePort 31111 (Keycloak) and 32000 (FastAPI app)
- **Self-signed TLS** generated by `certs/generate-certs.sh` (CA + server cert for `idp.keycloak.com`)
- **Keycloak PostgreSQL** single pod (manifests in `keycloak/postgresql/`)
- **App PostgreSQL** single pod for FastAPI app data (manifests in `keycloak/app-postgresql/`), credentials: `appuser`/`apppass`/`studentdb`
- **Redis** single pod for session storage (manifests in `keycloak/redis/`)
- **Keycloak StatefulSet** (3 replicas) with HTTPS on 8443, health on 9000, jdbc-ping cache stack
- **FastAPI Deployment** (3 replicas) in `keycloak/fastapi-app/` — uses `__NODE_IP__` placeholder in `app-deployment.yaml` for `hostAliases` (substituted via `sed` at deploy time so pods can reach `idp.keycloak.com`)
- **Realm setup** (`keycloak/realm-config/realm-setup.sh`) uses Keycloak Admin REST API to create the `student-mgmt` realm, `student-app` client, and three client roles (admin, student, staff) with corresponding test users

### FastAPI App (`fastapi-app/`)

- **Entry point:** `run.py` → `app/main.py` (uvicorn with reload)
- **Config:** `config.py` uses pydantic-settings loading from `.env`. Key settings: `database_url`, `redis_url`, `keycloak_url`, `app_secret_key`
- **OAuth:** `app/auth.py` registers Keycloak as an Authlib OAuth provider with custom SSL context for self-signed certs
- **Auth flow:** `app/routes/auth_routes.py` handles `/login`, `/callback`, `/logout`. Tokens and user info stored in Redis-backed sessions.
- **Session middleware:** `app/session.py` — custom `RedisSessionMiddleware` (ASGI) using `redis.asyncio` + `itsdangerous` for signed cookies. 14-day TTL. Replaces Starlette's in-memory `SessionMiddleware` for multi-replica support.
- **RBAC:** `app/dependencies.py` — declarative dependencies:
  - `require_authenticated` — extracts user from session or raises 401
  - `require_admin` — checks admin role or raises 403
  - `inject_user_context` — returns `(user, roles)` tuple for templates
  - `get_student_for_user` — resource-level ownership check
  - Routes use `dependencies=[Depends(require_admin)]` on route decorators instead of inline checks
- **Database:** `app/database.py` — SQLAlchemy with conditional `connect_args` (supports both SQLite for local dev and PostgreSQL for deployed). `app/models.py` — `Student` (with optional `keycloak_user_id` FK) and `Department`.
- **Routes:** `app/routes/` — `student_routes.py` and `department_routes.py` handle CRUD with Jinja2 templates. Admin-only for create/edit; staff can view all; students see only own record.
- **Templates:** `templates/` — Jinja2 with `base.html` layout. Role-conditional UI elements (add/edit buttons hidden from non-admin).
- **Docker:** `Dockerfile` based on `python:3.12-slim`, copies CA cert for Keycloak TLS trust. `.dockerignore` excludes venv/tests/.env.

### Tests (`fastapi-app/tests/`)

42 E2E tests using **Playwright** (pytest-playwright). `conftest.py` sets up test data by calling Keycloak Admin API to resolve user IDs and inserting linked Student records. `APP_URL` is configurable via environment variable (default: `http://localhost:8000`, use `http://localhost:32000` for deployed). Test classes: `TestAuthentication`, `TestStudentCRUD`, `TestDepartmentCRUD`, `TestStudentRoleAccess`, `TestStaffRoleAccess`, `TestNavigation`, `TestFormValidation`, `TestErrorHandling`, `TestSessionConsistency`.

## Key URLs and Credentials

| Service | URL |
|---------|-----|
| Keycloak | https://idp.keycloak.com:31111 |
| Keycloak Admin | admin / admin |
| FastAPI (local) | http://localhost:8000 |
| FastAPI (deployed) | http://localhost:32000 (via NodePort or port-forward) |

Test users: `admin-user`/`admin123` (admin), `student-user`/`student123` (student), `staff-user`/`staff123` (staff)

## Role Permissions Matrix

| Action | admin | staff | student |
|--------|-------|-------|---------|
| View all students | yes | yes | no (own only) |
| Create/edit students | yes | no | no |
| View all departments | yes | yes | yes |
| Create/edit departments | yes | no | no |

## Deployment Pipeline

### Scripts

- **`scripts/build-test-deploy.sh`** — All-in-one: build Docker image, deploy to Kind (Redis + App PostgreSQL + FastAPI 3 replicas), seed DB, run E2E tests. Flags: `--skip-local`, `--deploy-only`, `--test-only`
- **`scripts/deploy-and-test.sh`** — Alternative deploy pipeline with flags: `--skip-local-tests`, `--skip-build`, `--only-deploy`, `--only-test-deployed`
- **`scripts/run-tests.sh`** — Reusable test runner. Flags: `--deployed`, `--start-app`, `--stop-app`, `--suite <class>`, `--filter <pattern>`
- **`scripts/create-test-data.py`** — Seeds departments + students (idempotent). Works with SQLite and PostgreSQL. Fetches Keycloak user IDs via Admin API.

### Key Deployment Details

- FastAPI app image: `fastapi-student-app:latest` (loaded to Kind via `kind load docker-image`)
- `app-deployment.yaml` uses `__NODE_IP__` placeholder for `hostAliases` — deploy scripts substitute it via `sed` so pods can resolve `idp.keycloak.com` to the Kind node IP
- If the Kind cluster was created without port 32000 in `kind-config.yaml`, use `kubectl port-forward -n keycloak svc/fastapi-app 32000:8000` instead of NodePort
- Deploy scripts automatically update Keycloak client redirect URIs to include `localhost:32000`
- The `keycloak-tls` secret must include `ca.crt` (alongside `tls.crt` and `tls.key`) — `setup.sh` handles this

### Enhancement Plan

Detailed plan document at `plans/2-multi-replica-deploy-auth-refactor.md` covering all 9 phases of the auth refactoring + multi-replica deployment work.
